# SPATIAL MODELLING OF SURVEY BIOMASS {#sec:spatial-modeling}

We modelled the expected biomass density in space for each species using geostatistical models applied to data from the fisheries independent bottom trawl and long line surveys (e.g. Figure \@ref(fig:survey-maps)). Our modeling approach is consistent with recent models used for spatiotemporal index standardization of fish populations [e.g. @shelton2014; @ward2015; @thorson2015; @thorson2016]. Such models have been shown, for example, to improve estimates of rockfish abundance and distribution [@shelton2014] and improve precision when estimating relative abundance indices for groundfish [@thorson2015]. Our specific model is implemented with INLA [@rue2009; @lindgren2015] and TMB (REF) via R [@rcoreteam2018], which enables rapid model fitting for these large spatial data sets.

At a high level, these models predict relative biomass in space as a continuous process with a quadratic effect for bottom depth, a random effect spatial surface that represents an amalgamation of spatial processes not explicitly included in the model, and an observation error component. After fitting the model to survey sets from trawl or longline surveys, we then project the model predictions on to a fine-scale 2 $\times$ 2 km grid in a UTM 9 projection to derive estimates of biomass throughout the survey domain.

Similarly to the commercial catch per unit effort standardization models, these models can be represented as Tweedie GLMMs (Generalized Linear Mixed-effects Models) with a log link:

\begin{align}
  y_s &\sim \mathrm{Tweedie}(\mu_s, p, \phi), \quad 1 < p < 2,\\
  \mu_s &= \exp \left( \bm{X}_s \bm{\beta} + \omega_s \right),
\end{align}

where $s$ represents a spatial location, $y_s$ represents observed fish density for a survey set, $\mu_s$ represents expected fish density, $p$ represents the Tweedie power parameter, and $\phi$ represents the Tweedie dispersion parameter. The vector $\bm{X_s}$ represents a vector of predictors (here a 1 for an intercept, depth, and depth squared) and $\bm{\beta}$ represents a corresponding vector of coefficients. The spatial random effects $\omega_s$ are assumed to be drawn from a multivariate normal distribution with a covariance matrix $\bm{\Sigma}_\omega$ that is centered on zero:

$$\bm{\omega} \sim \mathrm{MVNormal} \left( \bm{0}, \bm{\Sigma}_\omega \right).$$

We constrain the spatial random effects to follow a Mat\'ern covariance function... TODO


<!-- The Mat\'ern function describes the covariance between spatial locations $s_j$ and $s_k$ as: -->

<!-- $$\Phi\left( s_j,s_k \right) = \tau^2/\Gamma(\nu)2^{\nu - 1} -->
<!--     (\kappa d_{jk})^\nu K_\nu \left( \kappa d_{jk} \right),$$ -->

<!-- where $\tau^2$ represents the spatial variance, $\Gamma$ represents the Gamma function, $K_\nu$ represents the Bessel function, $d_{jk}$ represents the Euclidean distance between locations $s_j$ and $s_k$, and $\kappa$ represents a scaling parameter that is estimated.  -->

<!-- The parameter $\nu$ controls the smoothness of the covariance function. We set $\nu = 3/2$, as is commonly done when fitting similar spatial models [e.g. @ward2015; @thorson2015; @ono2016; @shelton2018], which lets the covariance function be more flexible than an exponential covariance function but still be differentiable [@rasmussen2004]. -->

Instead of directly using depth and depth squared, we first centre the log -ransformed depth covariate by subtracting its mean and scaling it by its standard deviation. We then calculate "depth squared" from this centred and scaled variable. This ensures the covariate values are not too big or small to avoid computational issues and the centering separates the linear and quadratic predictor components.

We fit the four synoptic survey data sets separately, because only two of the
surveys are conducted each year and the surveys are disjointed in space and
time. Similarly, we fit the North and South HBLL surveys independently. We combined the predictions to generate the map plots, but labelled the
years the various surveys were conducted in.

```{r sdmTMB-data}
library(dplyr)
library(ggplot2)
library(sdmTMB)
d <- readRDS(here::here("report/data-cache/pacific-cod.rds"))
d <- d$survey_sets
dat <- gfplot:::tidy_survey_sets(d, "SYN QCS", years = 2017)
dat <- mutate(dat, density = density*1000*1000)
dat <- filter(dat, !is.na(depth))
dat <- gfplot:::scale_survey_predictors(dat)
dat <- select(dat, -X10, -Y10)

grid_locs <- gfplot:::make_prediction_grid(filter(dat, year == 2017),
  survey = "SYN QCS", cell_width = 1.5)$grid
grid_locs <- rename(grid_locs, depth = akima_depth)
grid_locs$year <- NULL
```

```{r sdmTMB-spde, fig.width=9, out.width="3.7in", fig.cap="Red indicates knots. Open circles represent the locations of the survey sets. TODO"}
spde <- make_spde(dat$X, dat$Y, n_knots = 200)
plot_spde(spde)
```

```{r sdmTMB-model}
m <- sdmTMB(
  data = dat, formula = density ~ depth_scaled + depth_scaled2,
  time = "year", spde = spde, family = tweedie(link = "log"),
  silent = TRUE, anisotropy = FALSE
)
```

```{r sdmTMB-resids, fig.width=6, out.width="4in", fig.cap="Spatial residuals TODO"}
dat$resids <- residuals(m) # randomized quantile residuals
# hist(dat$resids)
# qqnorm(dat$resids);abline(a = 0, b = 1)
ggplot(dat, aes(X, Y, col = resids)) + scale_colour_gradient2() +
  geom_point() + coord_fixed() +
  xlab("Easting") + ylab("Northing") +
  scale_colour_gradient2(midpoint = 0,
    high = scales::muted("red"),
    mid = "white",
    low = scales::muted("blue")) +
  labs(colour = 'Residual')
```

```{r sdmTMB-preds, fig.width=6, out.width="4in"}
predictions <- predict(m, newdata = grid_locs)
plot_map <- function(.dat, column) {
  ggplot(.dat, aes_string("X", "Y", fill = column)) +
    geom_raster() +
    coord_fixed(expand = FALSE) +
    xlab("Easting") + ylab("Northing") +
    theme(legend.position = "bottom") +
    geom_point(data = dat, aes(X, Y, size = density), pch = 21, inherit.aes = FALSE) +
    scale_size_area() +
    guides(size = FALSE)
}
```

```{r sdmTMB-plot-depth}
g_depth <- plot_map(grid_locs, "depth") +
  scale_fill_viridis_c(trans = "sqrt", option = "A", direction = -1) +
  ggtitle("Depth") +
  labs(fill = 'Depth (m)')
```

```{r sdmTMB-plot-combined}
g_sdm1 <- plot_map(predictions$data, "exp(est)") +
  scale_fill_viridis_c(trans = "sqrt", option = "C") +
  ggtitle("Prediction (depth effects + spatial random effects)") +
  labs(fill = 'Biomass estimate\nkg/km^2')
```

```{r sdmTMB-plot-fe}
g_sdm2 <- plot_map(predictions$data, "exp(est_fe)") +
  ggtitle("Prediction (depth effects only)") +
  scale_fill_viridis_c(trans = "sqrt", option = "D") +
  labs(fill = 'Biomass estimate\nkg/km^2')
```

```{r sdmTMB-plot-re}
g_sdm3 <- plot_map(predictions$data, "est_re_s") +
  ggtitle("Spatial random effects") +
  scale_fill_gradient2(midpoint = 0,
    high = scales::muted("red"),
    mid = "white",
    low = scales::muted("blue")) +
  labs(fill = 'Deviation from expected\nbiomass in log space')
```

```{r sdmTMB-maps-combined, fig.width=9, fig.asp=1, out.width="6in", fig.cap="Example spatial model components in Queen Charlotte Sound for Pacific Cod."}
cowplot::plot_grid(g_depth, g_sdm2, g_sdm3, g_sdm1)
```

\clearpage

