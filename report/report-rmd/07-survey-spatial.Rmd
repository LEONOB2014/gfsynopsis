# SPATIAL MODELLING OF SURVEY BIOMASS {#sec:spatial-modeling}

We modelled the expected biomass density in space for each species using geostatistical models applied to data from the fisheries independent bottom trawl and long line surveys (e.g. Figure \@ref(fig:survey-maps)). Our modeling approach is consistent with recent models used for spatiotemporal index standardization of fish populations [e.g. @shelton2014; @ward2015; @thorson2015; @thorson2016]. Such models have been shown, for example, to improve estimates of rockfish abundance and distribution [@shelton2014] and improve precision when estimating relative abundance indices for groundfish [@thorson2015]. Our specific model is implemented with INLA [@rue2009; @lindgren2015] and TMB [@kristensen2016] via R [@r2018], which enables rapid model fitting for these large spatial data sets.

At a high level, these models predict relative biomass in space as a continuous process with a quadratic effect for bottom depth, spatial random effects that represent an amalgamation of spatial processes not explicitly included in the model, and an observation error component. After fitting the model to survey sets from trawl or longline surveys, we then project the model predictions on to a fine-scale 2 $\times$ 2 km grid in a UTM 9 projection to derive estimates of biomass throughout the survey domain.

Similarly to the commercial catch per unit effort standardization models (Section (\@ref(sec:cpue-models))), these models can be represented as Tweedie GLMMs (generalized linear mixed-effects models) with a log link:

\begin{align}
  y_s &\sim \mathrm{Tweedie}(\mu_s, p, \phi), \quad 1 < p < 2,\\
  \mu_s &= \exp \left( \bm{X}_s \bm{\beta} + \omega_s \right),
\end{align}

where $s$ represents a spatial location, $y_s$ represents observed fish density for a survey set, $\mu_s$ represents expected fish density, $p$ represents the Tweedie power parameter, and $\phi$ represents the Tweedie dispersion parameter. The vector $\bm{X_s}$ represents a vector of predictors (here a 1 for an intercept, depth, and depth squared) and $\bm{\beta}$ represents a corresponding vector of coefficients. The spatial random effects $\omega_s$ are assumed to be drawn from a multivariate normal distribution with a covariance matrix $\bm{\Sigma}_\omega$ that is centered on zero:

$$\bm{\omega} \sim \mathrm{MVNormal} \left( \bm{0}, \bm{\Sigma}_\omega \right).$$

We constrain the spatial random effects to follow a \mbox{Mat\'ern} covariance function, which simply defines the shape with which spatial correlation decays with distance (Figure \@ref(fig:sdmTMB-matern-demo)). The \mbox{Mat\'ern} function describes the covariance between spatial locations $s_j$ and $s_k$ as:

$$\Phi\left( s_j,s_k \right) = \tau^2/\Gamma(\nu)2^{\nu - 1}
    (\kappa d_{jk})^\nu K_\nu \left( \kappa d_{jk} \right),$$

where $\tau^2$ represents the spatial variance, $\Gamma$ represents the Gamma function, $K_\nu$ represents the Bessel function, $d_{jk}$ represents the Euclidean distance between locations $s_j$ and $s_k$, and $\kappa$ represents a scaling parameter that is estimated [e.g. @lindgren2011]. The parameter $\nu$ controls the smoothness of the covariance function. We set $\nu = 1$, which lets us take advantage of the Stochastic Partial Differential Equation (SPDE) approximation to Gaussian Markov Random Fields (GMRF) [@lindgren2011] to greatly increase computational efficiency.

Instead of directly modelling the effects of depth and depth squared, we first centred the log-transformed depth covariate by subtracting its mean and scaling it by its standard deviation. We then calculate "depth squared" from this centred and scaled variable. This ensures the covariate values are not too big or small to avoid computational issues and the centering separates the linear and quadratic predictor components.

We fit the four synoptic survey data sets separately, because only two of the surveys are conducted each year and the surveys are disjointed in space and time. Similarly, we fit the North and South HBLL surveys independently. We combined the predictions to generate the map plots, but labelled the years the various surveys were conducted in.

TODO: 
- how many knots and why
- what the triangular mesh shows
- the projec-tion matrix from INLA
- how this differs from VAST
- compared to glmmfields, VAST
- note the spatial residual example (Figure \@ref(fig:sdmTMB-resids))
- note the multipanel plot: (Figure \@ref(fig:sdmTMB-maps-combined)) that includes depth, fixed effects, spatial random effects, and combined fixed and random effect predictions in that order

```{r sdmTMB-matern-demo, fig.asp=0.3, fig.width=8, fig.cap="An illustration of the effect of the $\\kappa$ parameter ('kappa') on the shape of the \\mbox{Mat\\'ern} correlation function with $\\nu = 1$. The vertical dashed line illustrates $\\sqrt{8\\nu} / \\kappa$, referred to as the 'range', which is a point at which the correlation decreases below 0.1."}
library(dplyr)
library(ggplot2)
dist <- seq(0, 13, length = 200)
kappa <- c(0.3, 0.5, 1.1)
nu <- 1.0
plyr::ldply(kappa, function(k) {
  data.frame(
    Correlation = k * dist * base::besselK(k * dist, nu),
    kappa = paste("kappa =", k),
    Distance = dist,
    range = sqrt(8 * 1) / k
  )
}) %>%
  mutate(Correlation = ifelse(is.na(Correlation), 1, Correlation)) %>%
  ggplot(aes(Distance, Correlation)) +
  geom_line() +
  facet_wrap(~kappa) +
  geom_vline(aes(xintercept = range), lty = 2) +
  coord_cartesian(expand = FALSE, ylim = c(0, 1)) +
  theme(strip.text.x = element_text(colour = "grey20", size = rel(1.1)))
```


```{r sdmTMB-data}
library(dplyr)
library(ggplot2)
library(sdmTMB)
d <- readRDS(here::here("report/data-cache/pacific-cod.rds"))
d <- d$survey_sets
dat <- gfplot:::tidy_survey_sets(d, "SYN QCS", years = 2017)
dat <- mutate(dat, density = density*1000*1000)
dat <- filter(dat, !is.na(depth))
dat <- gfplot:::scale_survey_predictors(dat)
dat <- select(dat, -X10, -Y10)

grid_locs <- gfplot:::make_prediction_grid(filter(dat, year == 2017),
  survey = "SYN QCS", cell_width = 1.5)$grid
grid_locs <- rename(grid_locs, depth = akima_depth)
grid_locs$year <- NULL
```

```{r sdmTMB-spde, fig.width=9, out.width="3.7in", fig.cap="Red indicates knots. Open circles represent the locations of the survey sets. TODO"}
spde <- make_spde(dat$X, dat$Y, n_knots = 200)
plot_spde(spde)
```

```{r sdmTMB-model}
m <- sdmTMB(
  data = dat, formula = density ~ depth_scaled + depth_scaled2,
  time = "year", spde = spde, family = tweedie(link = "log"),
  silent = TRUE, anisotropy = FALSE
)
```

```{r sdmTMB-temp1, eval=FALSE}
x <- seq(min(dat$depth_scaled), max(dat$depth_scaled), length.out = 200)
x2 <- x^2
idx <- order(x)
i <- 1:3
y <- m$model$par[[i[1]]] + x * m$model$par[[i[2]]] + x2 * m$model$par[[i[3]]]
out <- data.frame(
  depth = -1*exp(x[idx] * m$data$depth_sd[1] + m$data$depth_mean[1]), 
  y = exp(y[idx]))
ggplot(out, aes(depth, y)) + geom_line() +
  coord_cartesian(xlim = c(-300, 0)) +
  labs(x = 'Depth (m)', y = 'Biomass density (TODO)')
```

```{r sdmTMB-temp2, eval=FALSE}
surveys <- c("SYN QCS", "SYN HS", "SYN WCHG", "SYN WCVI")
fi <- list.files("report/map-cache/synoptic", full.names = FALSE)
out <- purrr::map_df(fi, function(i) {
  mm <- readRDS(paste0("report/map-cache/synoptic/", i))
  out <- purrr::map_df(1:4, function(ii) {
    if (length(mm$models[[ii]]$models) > 1L) {
      rd <- dplyr::filter(mm$raw_dat, survey == surveys[ii])
      # x <- seq(min(rd$depth_scaled, na.rm = TRUE), 
      #   max(rd$depth_scaled, na.rm = TRUE), length.out = 200)
      range_d <- -1 * exp(rd$depth_mean[1] + 
          range(rd$depth_scaled, na.rm = TRUE) * rd$depth_sd[1])
      x <- seq(-3, 4, length.out = 300)
      x2 <- x^2
      B <- mm$models[[ii]]$models$model$par
      y <- B[[1]] + x * B[[2]] + x2 * B[[3]]
      out <- data.frame(
        depth = -1*exp(x * rd$depth_sd[1] + rd$depth_mean[1]), 
        y = exp(y), survey = surveys[ii], 
        species = gsub("-", " ", gsub(".rds", "", i)),
        stringsAsFactors = FALSE)
      out <- mutate(out, 
        extrapolated = depth < min(range_d) * 1 | 
          depth > max(range_d) * 1)
      out
    }
  })
  out
})
library(ggplot2)
library(dplyr)
dd <- out %>% group_by(species, survey) %>% 
  # mutate(y = y / max(y))
  mutate(max_y = max(y[!extrapolated])) %>% 
  mutate(y = ifelse(y < max_y * 1.15, y, NA)) %>% 
  mutate(mode_depth = depth[y == max(y)[1]]) %>% 
  group_by(species) %>%
  mutate(mean_mode_depth = mean(mode_depth))

ggplot(dd, aes(depth, y, colour = survey)) + 
  geom_line(lty = 2) +
  coord_cartesian(xlim = c(-800, 0), ylim = ) +
  labs(x = 'Depth (m)', y = 'Biomass density (TODO)') +
  # facet_wrap(~forcats::fct_reorder(species, 
  #   mean_mode_depth), 
  facet_wrap(~species, scales = "free_y") +
  geom_line(data = filter(dd, !extrapolated), lwd = 0.9) +
  scale_color_brewer(palette = "Dark2") +
  gfplot::theme_pbs()
```


```{r sdmTMB-resids, fig.width=6, out.width="4in", fig.cap="Spatial residuals TODO"}
dat$resids <- residuals(m) # randomized quantile residuals
# hist(dat$resids)
# qqnorm(dat$resids);abline(a = 0, b = 1)
ggplot(dat, aes(X, Y, col = resids)) + scale_colour_gradient2() +
  geom_point() + coord_fixed() +
  xlab("Easting") + ylab("Northing") +
  scale_colour_gradient2(midpoint = 0,
    high = scales::muted("red"),
    mid = "white",
    low = scales::muted("blue")) +
  labs(colour = 'Residual')
```

```{r sdmTMB-preds, fig.width=6, out.width="4in"}
predictions <- predict(m, newdata = grid_locs)
plot_map <- function(.dat, column) {
  ggplot(.dat, aes_string("X", "Y", fill = column)) +
    geom_raster() +
    coord_fixed(expand = FALSE) +
    xlab("Easting") + ylab("Northing") +
    theme(legend.position = "bottom") +
    geom_point(data = dat, aes(X, Y, size = density), pch = 21, inherit.aes = FALSE) +
    scale_size_area() +
    guides(size = FALSE)
}
```

```{r sdmTMB-plot-depth}
g_depth <- plot_map(grid_locs, "depth") +
  scale_fill_viridis_c(trans = "sqrt", option = "A", direction = -1) +
  ggtitle("Depth") +
  labs(fill = 'Depth (m)')
```

```{r sdmTMB-plot-combined}
g_sdm1 <- plot_map(predictions$data, "exp(est)") +
  scale_fill_viridis_c(trans = "sqrt", option = "C") +
  ggtitle("Prediction (depth effects + spatial random effects)") +
  labs(fill = 'Biomass estimate\nkg/km^2')
```

```{r sdmTMB-plot-fe}
g_sdm2 <- plot_map(predictions$data, "exp(est_fe)") +
  ggtitle("Prediction (depth effects only)") +
  scale_fill_viridis_c(trans = "sqrt", option = "D") +
  labs(fill = 'Biomass estimate\nkg/km^2')
```

```{r sdmTMB-plot-re}
g_sdm3 <- plot_map(predictions$data, "est_re_s") +
  ggtitle("Spatial random effects") +
  scale_fill_gradient2(midpoint = 0,
    high = scales::muted("red"),
    mid = "white",
    low = scales::muted("blue")) +
  labs(fill = 'Deviation from expected\nbiomass in log space')
```

```{r sdmTMB-maps-combined, fig.width=9, fig.asp=1, out.width="6in", fig.cap="Example spatial model components in Queen Charlotte Sound for Pacific Cod. (Top left) Bottom depth data that is used as a predictor. (Top right) Predicted biomass density from the quadratic effect of depth only. (Lower left) Spatial random effect deviations. These deviations represent on modelled correlated spatial effects. (Lower right) Model productions that include both the depth fixed effects and the spatial random effects."}
cowplot::plot_grid(g_depth, g_sdm2, g_sdm3, g_sdm1)
```

\clearpage

